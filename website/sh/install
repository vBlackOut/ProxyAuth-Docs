#!/bin/bash

set -e
sudo -i
echo "[*] Detecting Linux distribution..."

# Detect distro
if [ -f /etc/alpine-release ]; then
    DISTRO="alpine"
elif [ -f /etc/debian_version ]; then
    DISTRO="debian"
elif [ -f /etc/arch-release ]; then
    DISTRO="arch"
elif [ -f /etc/redhat-release ]; then
    DISTRO="fedora"
else
    echo "[!] Unsupported Linux distribution."
    exit 1
fi

echo "[*] Detected distribution: $DISTRO"
echo "[*] Installing dependencies..."

case "$DISTRO" in
    alpine)
        sudo apk add --no-cache openssl openssl-libs-static openssl-dev musl-dev build-base pkgconf alpine-sdk sudo curl
        ;;
    debian)
        sudo apt update
        sudo apt install -y openssl libssl-dev build-essential pkgconf sudo curl
        ;;
    arch)
        sudo pacman -Sy --noconfirm openssl base-devel pkgconf sudo curl
        ;;
    fedora)
        sudo dnf install -y openssl openssl-devel gcc make pkgconf sudo curl
        ;;
esac

# Install Rust if not found
if ! command -v cargo &> /dev/null; then
    echo "[*] cargo not found, installing Rust via rustup..."
    curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sudo sh -s -- -y
    source "$HOME/.cargo/env"
else
    echo "[*] cargo is already installed."
fi

echo "[*] Installing proxyauth using cargo..."
cargo install --root /usr/local -j $(($(nproc) - 1)) proxyauth@0.5.6 --force --no-track

# Ensure /usr/local/bin/proxyauth is executable
sudo chmod +x /usr/local/bin/proxyauth

echo "[*] Running 'proxyauth prepare'..."
sudo /usr/local/bin/proxyauth prepare

# Check for systemd
if pidof systemd > /dev/null; then
    echo "[*] systemd detected. Setting up proxyauth.service..."

    sudo bash -c 'cat > /etc/systemd/system/proxyauth.service' << 'EOF'
[Unit]
Description=ProxyAuth Service
After=network.target

[Service]
Type=simple
User=proxyauth
Group=proxyauth
ExecStart=/usr/local/bin/proxyauth
Restart=on-failure
RestartSec=5
Environment=RUST_LOG=info

[Install]
WantedBy=multi-user.target
EOF

    echo "[*] Reloading systemd daemon and enabling service..."
    sudo systemctl daemon-reload
    sudo systemctl enable proxyauth
    sudo systemctl restart proxyauth

    echo "[*] proxyauth.service installed and running!"
else
    echo "[!] Warning: systemd not detected. Manual service setup required."
fi

echo "[*] proxyauth setup complete."
