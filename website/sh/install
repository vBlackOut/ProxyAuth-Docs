#!/bin/bash

set -e

echo "[*] Detecting Linux distribution..."

# Detect distro
if [ -f /etc/alpine-release ]; then
    DISTRO="alpine"
elif [ -f /etc/debian_version ]; then
    DISTRO="debian"
elif [ -f /etc/arch-release ]; then
    DISTRO="arch"
elif [ -f /etc/redhat-release ]; then
    DISTRO="fedora"
else
    echo "[!] Unsupported Linux distribution."
    exit 1
fi

echo "[*] Detected distribution: $DISTRO"
echo "[*] Installing dependencies..."

case "$DISTRO" in
    alpine)
        sudo apk add --no-cache openssl openssl-libs-static openssl-dev musl-dev build-base pkgconf alpine-sdk sudo curl
        ;;
    debian)
        sudo apt update
        sudo apt install -y openssl libssl-dev build-essential pkgconf sudo curl
        ;;
    arch)
        sudo pacman -Sy --noconfirm openssl base-devel pkgconf sudo curl
        ;;
    fedora)
        sudo dnf install -y openssl openssl-devel gcc make pkgconf sudo curl
        ;;
esac

# Install Rust if cargo is not found
if ! command -v cargo &> /dev/null; then
    echo "[*] cargo not found, installing Rust via rustup..."
    curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
    source "$HOME/.cargo/env"
else
    echo "[*] cargo is already installed."
fi

echo "[*] Installing proxyauth using cargo..."
sudo cargo install --root /usr/local -j $(($(nproc) - 1)) proxyauth --force

echo "[*] Running 'proxyauth prepare'..."
sudo proxyauth prepare

echo "[*] proxyauth setup complete."
