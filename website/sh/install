#!/bin/bash

set -e

echo "[*] Detecting Linux distribution..."

# Detect distro
if [ -f /etc/alpine-release ]; then
    DISTRO="alpine"
elif [ -f /etc/debian_version ]; then
    DISTRO="debian"
elif [ -f /etc/arch-release ]; then
    DISTRO="arch"
elif [ -f /etc/redhat-release ]; then
    DISTRO="fedora"
else
    echo "[!] Unsupported Linux distribution."
    exit 1
fi

echo "[*] Detected distribution: $DISTRO"
echo "[*] Installing dependencies..."

case "$DISTRO" in
    alpine)
        sudo apk add --no-cache openssl openssl-libs-static openssl-dev musl-dev build-base pkgconf alpine-sdk sudo
        ;;
    debian)
        sudo apt update
        sudo apt install -y openssl libssl-dev musl musl-dev build-essential pkgconf sudo
        ;;
    arch)
        sudo pacman -Sy --noconfirm openssl musl musl-dev base-devel pkgconf sudo
        ;;
    fedora)
        sudo dnf install -y openssl openssl-devel musl musl-devel gcc make pkgconf sudo
        ;;
esac

echo "[*] Installing proxyauth using cargo..."
sudo cargo install --root /usr/local -j $(($(nproc) - 1)) proxyauth --force

echo "[*] Running 'proxyauth prepare'..."
sudo proxyauth prepare

echo "[âœ”] proxyauth setup complete."
